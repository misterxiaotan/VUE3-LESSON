{
  "version": 3,
  "sources": ["../src/effect.ts", "../../shared/src/index.ts", "../src/track.ts", "../src/notify.ts", "../src/baseHandler.ts", "../src/reactive.ts", "../src/ref.ts"],
  "sourcesContent": ["export function effect(fn: any, options: any) {\n    const _effect = new ReactiveEffect(fn, () => {\n        _effect.run();\n    })\n}\n\nexport let activeEffect: ReactiveEffect | null;\n\n\nfunction preCleanEffect(effect: ReactiveEffect) {\n    effect._dep_length = 0;\n    effect._trackId++;\n}\n\nclass ReactiveEffect {\n    public active = true;\n    public _trackId = 0; // \u5F53\u524Deffcet \u6267\u884C\u7684\u6B21\u6570\n    public _dep_length = 0; // \u5F53\u524D deps \u6570\u7EC4\u7684\u957F\u5EA6\n    public deps = [] as Map<any, any>[];\n    constructor(public fn: any, public scheduler: () => void) {\n        this.run(); //\u4F9D\u8D56\u6536\u96C6\n    }\n    run() {\n        if (!this.active) {\n            return this.fn();\n        }\n        let lastEffcet = activeEffect;\n        try {\n            activeEffect = this;\n            preCleanEffect(this);\n            return this.fn();\n        } finally {\n            activeEffect = lastEffcet;\n        }\n    }\n    stop() {\n        this.active = false;\n    }\n}\n\nexport function trackEffect(effect: ReactiveEffect, dep: Map<any, any>) {\n    // \u91CD\u65B0\u6536\u96C6\u4F9D\u8D56\uFF0C\u5C06\u4E0D\u9700\u8981\u7684\u79FB\u9664\u6389\n    // console.log(effect, dep, 'effect && dep')\n    if (dep.get(effect) !== effect._trackId) {\n        dep.set(effect, effect._trackId);\n\n        let oldDep = effect.deps[effect._dep_length];\n        if (oldDep !== dep) {\n            if (oldDep) {\n                (oldDep as any).clearUp()\n            }\n            effect.deps[effect._dep_length++] = dep;\n        } else {\n            effect._dep_length++\n        }\n    }\n    console.log('\u4F18\u5316\u4E86\u591A\u4F59\u7684\u6536\u96C6')\n\n}\n", "export function isObject(value: any) {\n    return typeof value === 'object' && value !== null;\n}", "import { activeEffect, trackEffect } from \"./effect\";\nexport const ReactiveMap = new WeakMap();\n\nexport function createDep(key: any, clearUp: () => any) {\n    const dep = new Map() as any;\n    dep.clearUp = clearUp;\n    dep.name = key;\n    return dep;\n}\n\nexport function track(target: any, key: string | symbol) {\n    if (activeEffect) {\n        let depsMap = ReactiveMap.get(target);\n        if (!depsMap) {\n            ReactiveMap.set(target, depsMap = new Map());\n        }\n        let dep = depsMap.get(key);\n        if (!dep) {\n            depsMap.set(key, dep = createDep(key, () => depsMap.delete(key)));\n        }\n        trackEffect(activeEffect, dep)\n        console.log(ReactiveMap, 'ReactiveMap')\n    }\n}", "import { activeEffect, effect } from \"./effect\";\nimport { ReactiveMap } from \"./track\";\n\nexport function notify(target, key, value, oldValue) {\n    // console.log('\u89E6\u53D1\u4F9D\u8D56\u66F4\u65B0', ReactiveMap)\n    const notifyMap = ReactiveMap.get(target)\n    if (notifyMap) {\n        const dep = notifyMap.get(key)\n        if (dep) {\n            triggerEffects(dep);\n        } else {\n            console.log('\u6CA1\u6709\u8BE5\u4F9D\u8D56', key)\n        }\n    }\n    console.log(ReactiveMap, 'ReactiveMap')\n}\n\nexport function triggerEffects(dep: any) {\n    console.log(dep, 'triggerEffect')\n    const keys = [...dep.keys()];\n    keys.forEach(effect => {\n        effect.scheduler();\n    });\n}", "import { activeEffect } from \"./effect\";\nimport { notify } from \"./notify\";\nimport { track } from \"./track\";\n\nexport enum ReactiveFlags {\n    IS_REACTIVE = '__v_isReactive',\n}\nexport const mutableHandlers: ProxyHandler<any> = {\n    get(target, key, receiver) {\n        if (key === ReactiveFlags.IS_REACTIVE) return true\n        if (activeEffect) {\n            track(target, key);\n        }\n        return Reflect.get(target, key, receiver);\n    },\n    set(target, key, value, receiver) {\n        const oldValue = target[key];\n        let result = Reflect.set(target, key, value, receiver);\n        if (oldValue !== value) {\n            notify(target, key, value, oldValue);\n        }\n        return result\n    }\n} ", "import { isObject } from \"@vue/shared\"\nimport { mutableHandlers, ReactiveFlags } from \"./baseHandler\";\n\nconst reactiveMap = new WeakMap();\n\nexport function reactive(target: any) {\n    if (!isObject(target)) return;\n    if (target[ReactiveFlags.IS_REACTIVE]) return target\n    return createReactiveObject(target);\n\n}\nfunction createReactiveObject(target: any) {\n    const exitsProxy = reactiveMap.get(target);\n    // \u7F13\u5B58\n    if (exitsProxy) {\n        return exitsProxy;\n    } else {\n        const proxy = new Proxy(target, mutableHandlers)\n        reactiveMap.set(target, proxy);\n        return proxy;\n    }\n\n}\nexport function toReactive(value: any) {\n    return isObject(value) ? reactive(value) : value;\n}", "import { activeEffect, trackEffect } from \"./effect\";\nimport { triggerEffects } from \"./notify\";\nimport { toReactive } from \"./reactive\";\nimport { createDep } from \"./track\";\n\nexport function ref(value: any) {\n    return createRef(value);\n}\n\nfunction createRef(value: any) {\n    return new RefImpl(value);\n}\n\nclass RefImpl {\n    private __v_isRef = true;\n    public _value: any;\n    public dep: any;\n    constructor(public _rawValue: any) {\n        this._value = toReactive(_rawValue);\n    }\n    get value() {\n        // track\n        trackRefValue(this);\n        return this._value;\n    }\n    set value(newVal) {\n        if (newVal !== this._value) {\n            this._rawValue = newVal;\n            this._value = newVal;\n\n            // trigger\n            triggerRefValue(this);\n        }\n\n    }\n}\nfunction trackRefValue(ref: RefImpl) {\n    if (activeEffect) {\n        ref.dep = createDep('undefind', () => ref.dep = undefined);\n        trackEffect(activeEffect, ref.dep);\n    }\n}\n\nfunction triggerRefValue(ref: RefImpl) {\n    triggerEffects(ref.dep)\n}"],
  "mappings": "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",
  "names": ["effect", "effect", "ref"]
}
